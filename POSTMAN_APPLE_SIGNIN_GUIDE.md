# Apple Sign-In Authentication - Postman Testing Guide

## Overview

This guide explains how to test the Apple Sign-In authentication endpoint (`POST /api/v1/auth/apple`) using Postman.

**Important:** Apple Sign-In requires a valid Apple identity token (JWT) generated by Apple's SDK. You cannot manually create a valid Apple token - it must come from an iOS/macOS app or web application using Apple's Sign In with Apple service.

---

## Prerequisites

1. **Apple Developer Account** (for production)
2. **Apple OAuth Client ID** configured in `application.yml`
3. **Valid Apple Identity Token** (JWT string from Apple)

---

## Step 1: Get an Apple Identity Token

### Option A: From iOS/macOS App (Recommended for Testing)

1. **Create a test iOS/macOS app** with Sign In with Apple enabled
2. **Sign in with Apple** in your app
3. **Extract the identity token** from the app's response
4. **Copy the token** - it's a long JWT string

### Option B: From Web Application

1. **Implement Sign In with Apple** in your web app
2. **Get the identity token** from Apple's response
3. **Copy the token** for use in Postman

### Option C: Using Apple's Test Environment (Development Only)

For development/testing, you can use Apple's test tokens, but they won't validate against your actual client ID.

---

## Step 2: Configure Postman Request

### Request Setup

1. **Method:** `POST`
2. **URL:** `http://localhost:8080/api/v1/auth/apple`
   - Or use your environment variable: `{{base_url}}/api/v1/auth/apple`

3. **Headers:**
   - `Content-Type: application/json`

4. **Body (raw JSON):**
   ```json
   {
     "identityToken": "eyJraWQiOiJlWGF1bm1ZM1F4WGp1M0xrcmZ0aUF3R0hZc1hxT2Z..."
   }
   ```

   **Note:** Replace `eyJraWQiOiJlWGF1bm1ZM1F4WGp1M0xrcmZ0aUF3R0hZc1hxT2Z...` with your actual Apple identity token.

---

## Step 3: Send Request

### Complete Postman Request Example

```http
POST http://localhost:8080/api/v1/auth/apple
Content-Type: application/json

{
  "identityToken": "eyJraWQiOiJlWGF1bm1ZM1F4WGp1M0xrcmZ0aUF3R0hZc1hxT2Z..."
}
```

---

## Step 4: Expected Responses

### ✅ Success Response (200 OK)

```json
{
  "success": true,
  "message": "Success",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "expiresIn": 86400000,
    "user": {
      "id": 1,
      "email": "user@example.com",
      "name": "John Doe",
      "firstName": "John",
      "lastName": "Doe",
      "phone": null,
      "isEmailVerified": true,
      "isPhoneVerified": false,
      "role": "USER"
    }
  },
  "timestamp": "2026-01-27T16:00:00Z"
}
```

**What to do next:**
1. Copy the `accessToken` from the response
2. Use it in the `Authorization` header for protected endpoints:
   ```
   Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   ```

---

### ❌ Error Responses

#### 1. Invalid Token (401 Unauthorized)

```json
{
  "success": false,
  "message": "Invalid Apple identity token. Please ensure the token is valid and not expired.",
  "error": {
    "code": "ERR_1100",
    "message": "Unauthorized"
  },
  "timestamp": "2026-01-27T16:00:00Z"
}
```

**Possible causes:**
- Token is expired
- Token signature is invalid
- Token issuer is not `https://appleid.apple.com`
- Token audience doesn't match your client ID

#### 2. Missing Token (400 Bad Request)

```json
{
  "success": false,
  "message": "Apple identity token is required",
  "error": {
    "code": "ERR_1001",
    "message": "Invalid Request"
  },
  "timestamp": "2026-01-27T16:00:00Z"
}
```

#### 3. Missing Subject (400 Bad Request)

```json
{
  "success": false,
  "message": "Subject (Apple user ID) not found in Apple token",
  "error": {
    "code": "ERR_1001",
    "message": "Invalid Request"
  },
  "timestamp": "2026-01-27T16:00:00Z"
}
```

---

## Step 5: Using the Access Token

After successful Apple Sign-In, you'll receive an `accessToken`. Use it to authenticate other API requests:

### Example: Get Current User

```http
GET http://localhost:8080/api/v1/users/me
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

## Postman Environment Variables (Recommended)

### Setup:

1. **Create/Edit Environment** in Postman
2. **Add variables:**
   - `base_url`: `http://localhost:8080`
   - `apple_identity_token`: (leave empty, paste token when needed)
   - `access_token`: (leave empty, will be set after login)

3. **In your Apple Sign-In request:**
   - Body: `{ "identityToken": "{{apple_identity_token}}" }`

4. **Auto-save access token** (add to Tests tab):
   ```javascript
   if (pm.response.code === 200) {
       const response = pm.response.json();
       if (response.data && response.data.accessToken) {
           pm.environment.set("access_token", response.data.accessToken);
           console.log("✅ Access token saved to environment");
       }
   }
   ```

5. **Use in other requests:**
   - Header: `Authorization: Bearer {{access_token}}`

---

## Testing Scenarios

### Scenario 1: First-Time User (Email Provided)

**Request:**
```json
{
  "identityToken": "<token_with_email>"
}
```

**Expected:**
- User created with `provider = APPLE`
- Email stored (if provided)
- `isEmailVerified = true` (if email provided)
- Access and refresh tokens returned

### Scenario 2: Returning User (No Email)

**Request:**
```json
{
  "identityToken": "<token_without_email>"
}
```

**Expected:**
- User found by `providerId` (Apple user ID)
- Email may be placeholder: `{sub}@apple.private`
- Access and refresh tokens returned

### Scenario 3: User with Existing Email

**Request:**
```json
{
  "identityToken": "<token_with_email_for_existing_user>"
}
```

**Expected:**
- User found by email or providerId
- User updated with Apple provider info
- Access and refresh tokens returned

---

## Troubleshooting

### Problem: "Invalid Apple identity token"

**Solutions:**
1. ✅ Verify the token is not expired
2. ✅ Check that `apple.oauth.client-id` is configured correctly in `application.yml`
3. ✅ Ensure the token's audience matches your client ID
4. ✅ Verify the token issuer is `https://appleid.apple.com`
5. ✅ Check that the token signature is valid (Apple public keys are fetched automatically)

### Problem: "Failed to fetch Apple public keys"

**Solutions:**
1. ✅ Check internet connection (service fetches keys from Apple's JWKS endpoint)
2. ✅ Verify Apple's JWKS endpoint is accessible: `https://appleid.apple.com/auth/keys`
3. ✅ Check server logs for detailed error messages

### Problem: Token works in app but not in Postman

**Possible causes:**
1. Token might be expired (Apple tokens expire quickly)
2. Token might be tied to a different client ID
3. Token format might be incorrect (should be a JWT string)

**Solution:** Generate a fresh token from your app and use it immediately in Postman.

---

## Apple Identity Token Structure

A valid Apple identity token is a JWT with the following structure:

**Header:**
```json
{
  "kid": "key-id",
  "alg": "RS256"
}
```

**Payload:**
```json
{
  "iss": "https://appleid.apple.com",
  "aud": "your-client-id",
  "exp": 1234567890,
  "iat": 1234567890,
  "sub": "apple-user-id",
  "email": "user@example.com",
  "email_verified": true
}
```

**Note:** Email is only provided on first login. Subsequent logins only include `sub` (Apple user ID).

---

## Quick Test Checklist

- [ ] Apple OAuth Client ID configured in `application.yml`
- [ ] Valid Apple identity token obtained from app
- [ ] Postman request configured with correct endpoint
- [ ] Request body contains `identityToken` field
- [ ] Response contains `accessToken` and `refreshToken`
- [ ] Access token works for authenticated requests

---

## Example: Complete Postman Collection

### Request: Apple Sign-In

**Method:** `POST`  
**URL:** `{{base_url}}/api/v1/auth/apple`  
**Headers:**
```
Content-Type: application/json
```

**Body (raw JSON):**
```json
{
  "identityToken": "{{apple_identity_token}}"
}
```

**Tests (auto-save token):**
```javascript
pm.test("Status code is 200", function () {
    pm.response.to.have.status(200);
});

pm.test("Response has access token", function () {
    const jsonData = pm.response.json();
    pm.expect(jsonData.data).to.have.property('accessToken');
    pm.expect(jsonData.data).to.have.property('refreshToken');
    
    // Auto-save tokens
    pm.environment.set("access_token", jsonData.data.accessToken);
    pm.environment.set("refresh_token", jsonData.data.refreshToken);
    
    console.log("✅ Tokens saved to environment");
});
```

---

## Summary

**To test Apple Sign-In in Postman:**

1. ✅ Get a valid Apple identity token from your iOS/macOS app or web app
2. ✅ Create POST request to `/api/v1/auth/apple`
3. ✅ Send `identityToken` in request body
4. ✅ Copy `accessToken` from response
5. ✅ Use `accessToken` in `Authorization: Bearer <token>` header for other requests

**Important Notes:**
- Apple tokens expire quickly - use them immediately
- Email is only provided on first login
- User is found by Apple user ID (`sub`) or email
- Both access and refresh tokens are returned

---

## Related Endpoints

After successful Apple Sign-In, you can use the access token with:

- `GET /api/v1/users/me` - Get current user profile
- `GET /api/v1/orders` - Get user orders
- `POST /api/v1/auth/refresh` - Refresh access token
- `POST /api/v1/auth/logout` - Logout

---

**Status: ✅ Ready for Testing**

